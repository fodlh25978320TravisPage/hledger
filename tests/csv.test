# These tests read CSV from stdin for convenience, so to ensure we get the CSV reader's
# error, the csv: prefix is used. 
#
# The final cleanup command is chained with && so as not to mask hledger's exit code,
# but this means a temp file is left behind whenever hledger fails. What TODO ?

# 1. read CSV to hledger journal format
$  printf 'fields date, description, amount\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\n' >t.$$.csv.rules; printf '10/2009/09,Flubber Co,50\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co
    assets:myacct               $50
    expense:unknown

>=0

# 2. reading CSV with in-field and out-field
<
10/2009/09,Flubber CoðŸŽ…,50,
11/2009/09,Flubber CoðŸŽ…,,50
$  printf 'account1 Assets:MyAccount\ndate %%1\ndate-format %%d/%%Y/%%m\ndescription %%2\namount-in %%3\namount-out %%4\ncurrency $\n' >t.$$.csv.rules ; hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber CoðŸŽ…
    Assets:MyAccount             $50
    expense:unknown

2009/09/11 Flubber CoðŸŽ…
    Assets:MyAccount            $-50
    income:unknown

>=0

# 3. handle conditions assigning multiple fields
$  printf 'fields date, description, amount\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\nif Flubber\n  account2 acct\n  comment cmt' >t.$$.csv.rules; printf '10/2009/09,Flubber Co,50\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co  ; cmt
    assets:myacct             $50
    acct

>=0

# 4. read CSV with balance field
$  printf 'fields date, description, amount, balance\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\n' >t.$$.csv.rules; printf '10/2009/09,Flubber Co,50,123\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co
    assets:myacct               $50 = $123
    expense:unknown

>=0

# 5. read CSV with empty balance field
$  printf 'fields date, description, amount, balance\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\n' >t.$$.csv.rules; printf '10/2009/09,Flubber Co,50,123\n11/2009/09,Blubber Co,60,\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co
    assets:myacct               $50 = $123
    expense:unknown

2009/09/11 Blubber Co
    assets:myacct               $60
    expense:unknown

>=0

# 6. read CSV with only whitespace in balance field
$  printf 'fields date, description, amount, balance\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\n' >t.$$.csv.rules; printf '10/2009/09,Flubber Co,50,123\n11/2009/09,Blubber Co,60,   \n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co
    assets:myacct               $50 = $123
    expense:unknown

2009/09/11 Blubber Co
    assets:myacct               $60
    expense:unknown

>=0

# 7. read CSV with rule double-negating column
$  printf 'skip 1\n\ncurrency $\n\nfields date, payee, payment\n\namount -%%payment\naccount1 liabilities:bank\naccount2 expense:other' >t.$$.csv.rules; printf 'date,payee,amount\n2009/10/9,Flubber Co,50\n2009/11/09,Merchant Credit,-60\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/10/09
    liabilities:bank            $-50
    expense:other

2009/11/09
    liabilities:bank             $60
    expense:other

>=0

# 8. reading with custom separator: SSV (semicolon-separated)
<
10/2009/09;Flubber CoðŸŽ…;50;
11/2009/09;Flubber CoðŸŽ…;;50
$  printf 'account1 Assets:MyAccount\ndate %%1\ndate-format %%d/%%Y/%%m\ndescription %%2\namount-in %%3\namount-out %%4\ncurrency $\n' >rules.$$ ; hledger --separator ';' -f csv:- --rules-file rules.$$ print && rm -rf rules.$$
2009/09/10 Flubber CoðŸŽ…
    Assets:MyAccount             $50
    expense:unknown

2009/09/11 Flubber CoðŸŽ…
    Assets:MyAccount            $-50
    income:unknown

>=0

# 9. read CSV with balance2 field
$  printf 'fields date, description, amount, balance2\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\n' >t.$$.csv.rules; printf '10/2009/09,Flubber Co,50,123\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co
    assets:myacct               $50
    expense:unknown     = $123

>=0

# 10. read CSV with balance1 and balance2 fields
$  printf 'fields date, description, amount, balance1, balance2\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\n' >t.$$.csv.rules; printf '10/2009/09,Flubber Co,50,321,123\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co
    assets:myacct               $50 = $321
    expense:unknown     = $123

>=0


# 11. More than two postings 
$  printf 'fields date, description, amount, balance1, balance2, amount3,comment3\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\naccount3   expenses:tax\n' >t.$$.csv.rules; printf '10/2009/09,Flubber Co,50,321,123,0.234,VAT\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co
    assets:myacct             $50 = $321
    unknown           = $123
    expenses:tax           $0.234  ; VAT

>=0

# 12. More than two postings and different currencies 
$  printf 'fields date, description, amount, balance1, balance2, currency3, amount3,comment3\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\naccount3   expenses:tax\n' >t.$$.csv.rules; printf '10/2009/09,Flubber Co,50,321,123,Â£,0.234,VAT\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co
    assets:myacct             $50 = $321
    unknown           = $123
    expenses:tax           Â£0.234  ; VAT

>=0

# 13. reading CSV with in-field and out-field, where one could be zero
<
10/2009/09,Flubber CoðŸŽ…,50,0
11/2009/09,Flubber CoðŸŽ…,0.00,50
$  printf 'account1 Assets:MyAccount\ndate %%1\ndate-format %%d/%%Y/%%m\ndescription %%2\namount-in %%3\namount-out %%4\ncurrency $\n' >t.$$.csv.rules ; hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber CoðŸŽ…
    Assets:MyAccount             $50
    expense:unknown

2009/09/11 Flubber CoðŸŽ…
    Assets:MyAccount            $-50
    income:unknown

>=0

# 14. multiline descriptions
$  printf 'fields date, description, amount\ndate-format %%d/%%Y/%%m\ncurrency $\naccount1 assets:myacct\n' >t.$$.csv.rules; printf '10/2009/09,"Flubber Co\n\n\n\nCo\nCo\n\n\n\n\n",50\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co Co Co
    assets:myacct               $50
    expense:unknown

>=0

# 15. recursive interpolation
$  printf 'fields account1, date, description, amount-in, amount-out\ndate-format %%d/%%Y/%%m\ncurrency $\nif Flubber\n    account1  assets:%%account1\n    amount-in  (%%amount-in)' >t.$$.csv.rules; printf 'myacct,10/2009/09,Flubber Co,50,\n' | hledger -f csv:- --rules-file t.$$.csv.rules print && rm -rf t.$$.csv.rules
2009/09/10 Flubber Co
    assets:myacct             $-50
    income:unknown

>=0

# 16. use a script for cleaner csv tests?
<
myacct,10/2009/09,Flubber Co,50,

RULES

fields account1, date, description, amount-in, amount-out
date-format %d/%Y/%m
currency $
if Flubber
  account1  assets:%account1
  amount-in  (%amount-in)
$  ./hledger-csv
2009/09/10 Flubber Co
    assets:myacct             $-50
    income:unknown

>=0

# . TODO: without --separator gives obscure error
#   |
# 1 | 10/2009/09;Flubber CoðŸŽ…;50;
#   | ^^^^^^^^^^
# well-formed but invalid date: 10/2009/9
# <
# 10/2009/09;Flubber CoðŸŽ…;50;
# 11/2009/09;Flubber CoðŸŽ…;;50
# $  printf 'account1 Assets:MyAccount\ndate %%1\ndate-format %%d/%%Y/%%m\ndescription %%2\namount-in %%3\namount-out %%4\ncurrency $\n' >rules.$$ ; hledger -f csv:- --rules-file rules.$$ print && rm -rf rules.$$
# 2009/09/10 Flubber CoðŸŽ…
#     Assets:MyAccount             $50
#     income:unknown              $-50
#
# 2009/09/11 Flubber CoðŸŽ…
#     Assets:MyAccount            $-50
#     expenses:unknown             $50
#
# >=0

# . reading TSV (tab-separated)  TODO user error (CSV record ["10/2009/09\tFlubber Co\127877\t50\t"] has less than two fields)
# <
# 10/2009/09	Flubber CoðŸŽ…	50	
# 11/2009/09	Flubber CoðŸŽ…		50
# $  printf 'account1 Assets:MyAccount\ndate %%1\ndate-format %%d/%%Y/%%m\ndescription %%2\namount-in %%3\namount-out %%4\ncurrency $\n' >rules.$$ ; hledger --separator "\t" -f csv:- --rules-file rules.$$ print && rm -rf rules.$$
# 2009/09/10 Flubber CoðŸŽ…
#     Assets:MyAccount             $50
#     income:unknown              $-50
#
# 2009/09/11 Flubber CoðŸŽ…
#     Assets:MyAccount            $-50
#     expenses:unknown             $50
#
# >=0
